
bar_expedition_init = {
	resize_array = {
		array = bar_expedition_members
		value = 1
		size = 5
	}
	set_variable = {
		bar_expedition_peril = 100
	}
	set_variable = {
		bar_expedition_success_chance = 100
	}
	set_variable = {
		bar_expedition_success_chance_bonus = 0
	}
	set_variable = {
		bar_expedition_cohesion = 100
	}
	set_variable = {
		bar_expedition_additional_equipment = 100
	}
	set_variable = {
		bar_expedition_length = 1
	}
}


bar_lower_cohesion = {
	if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 100
			}
		}
		set_variable = {
			bar_expedition_cohesion = 98
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 98
			}
		}
		set_variable = {
			bar_expedition_cohesion = 80
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 80
			}
		}
		set_variable = {
			bar_expedition_cohesion = 60
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 60
			}
		}
		set_variable = {
			bar_expedition_cohesion = 35
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 35
			}
		}
		set_variable = {
			bar_expedition_cohesion = 15
		}
	}
}

bar_raise_cohesion = {
	if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 98
			}
		}
		set_variable = {
			bar_expedition_cohesion = 100
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 80
			}
		}
		set_variable = {
			bar_expedition_cohesion = 98
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 60
			}
		}
		set_variable = {
			bar_expedition_cohesion = 80
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 35
			}
		}
		set_variable = {
			bar_expedition_cohesion = 60
		}
	}
	else_if = {
		limit = {
			check_variable = {
				bar_expedition_cohesion = 15
			}
		}
		set_variable = {
			bar_expedition_cohesion = 35
		}
	}
}

bar_expedition_adding_members_effects = {
	bar_lower_cohesion = yes
	subtract_from_variable = {
		bar_expedition_peril = 15
	}
	subtract_from_variable = {
		bar_expedition_success_chance = 10
	}
}

bar_expedition_removing_members_effects = {
	bar_raise_cohesion = yes
	add_to_variable = {
		bar_expedition_peril = 15
	}
	add_to_variable = {
		bar_expedition_success_chance = 10
	}
}

bar_expedition_additional_equipment_increase = {
	if = {
		limit = {
			check_variable = {
				bar_expedition_additional_equipment < 1000
			}
		}
		add_to_variable = {
			bar_expedition_additional_equipment = 100
		}
		subtract_from_variable = {
			bar_expedition_peril = 10
		}
	}
	bar_recalculate_expedition = yes
}

bar_expedition_additional_equipment_decrease = {
	if = {
		limit = {
			check_variable = {
				bar_expedition_additional_equipment > 100
			}
		}
		subtract_from_variable = {
			bar_expedition_additional_equipment = 100
		}
		add_to_variable = {
			bar_expedition_peril = 10
		}
	}
	bar_recalculate_expedition = yes
}

bar_recalculate_expedition = {
	add_to_variable = {
		bar_expedition_show = 1
	}
}

bar_expedition_week_end = {
	set_variable = {
		bar_expedition_phase_length = 7
	}
	add_to_variable = {
		bar_expedition_week = 1
	}
	bar_expedition_success_phase = yes
	set_variable_to_random = {
		var = rolled_peril
		min = 0
		max = 100
		integer = yes
	}
	set_variable_to_random = {
		var = rolled_cohesion
		min = 0
		max = 100
		integer = yes
	}
	if = {
		#peril phase
		limit = {
			check_variable = {
				var = bar_expedition_peril
				value = rolled_peril
				compare = greater_than_or_equals
			}
		}
		clear_array = bar_expedition_loot
		country_event = {
			id = bar_expedition.2
		}
	}
	else_if = {
		#cohesion phase
		limit = {
			check_variable = {
				var = rolled_cohesion
				value = bar_expedition_cohesion
				compare = greater_than_or_equals
			}
		}
		country_event = {
			id = bar_expedition.3
		}
	}
	else_if = {
		#expedition end
		limit = {
			check_variable = {
				var = bar_expedition_week
				value = bar_expedition_length
				compare = greater_than_or_equals
			}
		}
		country_event = {
			id = bar_expedition.4
		}
	}
	else = {
		#expedition continues
		activate_mission = BAR_expedition_progresses
	}
}

bar_expedition_success_phase = {
	for_each_loop = {
		array = bar_expedition_members
		index = character_index
		value = is_selected
		if = {
			limit = {
				check_variable = {
					is_selected = 2
				}
			}
			set_variable_to_random = {
				var = rolled_success_chance
				min = 0
				max = 100
				integer = yes
			}
			if = {
				limit = {
					check_variable = {
						value = rolled_success_chance
						var = bar_expedition_success_chance
						compare = greater_than_or_equals
					}
				}
				if = {
					limit = {
						check_variable = {
							character_index = 0
						}
					}
					bar_expedition_roll_gasienica_loot = yes
				}
				else_if = {
					limit = {
						check_variable = {
							character_index = 1
						}
					}
					bar_expedition_roll_silver_loot = yes
				}
				else_if = {
					limit = {
						check_variable = {
							character_index = 2
						}
					}
					bar_expedition_roll_leopold_loot = yes
				}
				else_if = {
					limit = {
						check_variable = {
							character_index = 3
						}
					}
					bar_expedition_roll_asinti_loot = yes
				}
				else_if = {
					limit = {
						check_variable = {
							character_index = 4
						}
					}
					bar_expedition_roll_viira_loot = yes
				}
			}
		}
	}
}

bar_expedition_roll_gasienica_loot = {
	random_list = {
		5 = {
			add_to_array = {
				bar_expedition_loot = 17
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 18
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 19
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 20
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 21
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 22
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 23
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 24
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 25
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 26
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 27
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 28
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 29
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 30
			}
		}
		5 = {
			add_to_array = {
				bar_expedition_loot = 31
			}
		}
	}
}

bar_expedition_roll_silver_loot = {
	random_list = {
		40 = {
			add_to_array = {
				bar_expedition_loot = 1
			}
		}
		30 = {
			add_to_array = {
				bar_expedition_loot = 2
			}
		}
		20 = {
			add_to_array = {
				bar_expedition_loot = 3
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 4
			}
		}
	}
}

bar_expedition_roll_leopold_loot = {
	random_list = {
		40 = {
			add_to_array = {
				bar_expedition_loot = 5
			}
		}
		30 = {
			add_to_array = {
				bar_expedition_loot = 6
			}
		}
		20 = {
			add_to_array = {
				bar_expedition_loot = 7
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 8
			}
		}
	}
}

bar_expedition_roll_asinti_loot = {
	random_list = {
		40 = {
			add_to_array = {
				bar_expedition_loot = 9
			}
		}
		30 = {
			add_to_array = {
				bar_expedition_loot = 10
			}
		}
		20 = {
			add_to_array = {
				bar_expedition_loot = 11
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 12
			}
		}
	}
}

bar_expedition_roll_viira_loot = {
	random_list = {
		40 = {
			add_to_array = {
				bar_expedition_loot = 13
			}
		}
		30 = {
			add_to_array = {
				bar_expedition_loot = 14
			}
		}
		20 = {
			add_to_array = {
				bar_expedition_loot = 15
			}
		}
		10 = {
			add_to_array = {
				bar_expedition_loot = 16
			}
		}
	}
}

bar_expedition_retrive_loot = {
	for_each_loop = {
		array = bar_expedition_loot
		value = loot_id
		if = {
			limit = {
				check_variable = {
					loot_id = 1
				}
			}
			bar_silver_resources_add_250 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 2
				}
			}
			bar_silver_resources_add_500 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 3
				}
			}
			bar_silver_resources_add_750 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 4
				}
			}
			bar_silver_resources_add_1000 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 5
				}
			}
			bar_leopold_resources_add_250 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 6
				}
			}
			bar_leopold_resources_add_500 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 7
				}
			}
			bar_leopold_resources_add_750 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 8
				}
			}
			bar_leopold_resources_add_1000 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 9
				}
			}
			bar_asinti_resources_add_250 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 10
				}
			}
			bar_asinti_resources_add_500 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 11
				}
			}
			bar_asinti_resources_add_750 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 12
				}
			}
			bar_asinti_resources_add_1000 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 13
				}
			}
			bar_viira_resources_add_250 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 14
				}
			}
			bar_viira_resources_add_500 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 15
				}
			}
			bar_viira_resources_add_750 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 16
				}
			}
			bar_viira_resources_add_1000 = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 17
				}
			}
			add_political_power = 25
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 18
				}
			}
			add_political_power = 50
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 19
				}
			}
			add_political_power = 75
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 20
				}
			}
			add_political_power = 100
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 21
				}
			}
			if = {
				limit = {
					var:bar_expedition_target = {
						has_tech = basic_train
					}
				}
				add_equipment_to_stockpile = {
					type = train_equipment
					producer = var:bar_expedition_target
					amount = 2
				}
			}
			else = {
				add_equipment_to_stockpile = {
					type = infantry_equipment
					producer = var:bar_expedition_target
					amount = 500
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 22
				}
			}
			add_equipment_to_stockpile = {
				type = infantry_equipment
				producer = var:bar_expedition_target
				amount = 500
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 23
				}
			}
			add_equipment_to_stockpile = {
				type = infantry_equipment
				producer = var:bar_expedition_target
				amount = 1000
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 24
				}
			}
			if = {
				limit = {
					var:bar_expedition_target = {
						has_tech = tech_trucks
					}
				}
				add_equipment_to_stockpile = {
					type = motorized_equipment
					producer = var:bar_expedition_target
					amount = 50
				}
			}
			else = {
				add_equipment_to_stockpile = {
					type = infantry_equipment
					producer = var:bar_expedition_target
					amount = 500
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 25
				}
			}
			one_random_industrial_complex = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 26
				}
			}
			one_random_arms_factory = yes
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 27
				}
			}
			add_manpower = 3000
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 28
				}
			}
			add_manpower = 6000
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 29
				}
			}
			add_equipment_to_stockpile = {
				type = artillery_equipment
				producer = var:bar_expedition_target
				amount = 50
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 30
				}
			}
			add_equipment_to_stockpile = {
				type = support_equipment
				producer = var:bar_expedition_target
				amount = 100
			}
		}
		else_if = {
			limit = {
				check_variable = {
					loot_id = 31
				}
			}
			if = {
				limit = {
					has_dlc = "No Step Back"
				}
				steal_random_tech_bonus = {
					folder = nsb_armour_folder
					folder = artillery_folder
					folder = infantry_folder
					folder = support_folder
					bonus = 2
					dynamic = yes
					instant = yes
					target = var:bar_expedition_target
					uses = 1
				}
			}
			else = {
				steal_random_tech_bonus = {
					folder = armour_folder
					folder = artillery_folder
					folder = infantry_folder
					folder = support_folder
					bonus = 2
					dynamic = yes
					instant = yes
					target = var:bar_expedition_target
					uses = 1
				}
			}
		}
		clear_array = bar_expedition_loot
	}
}